<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zichengma.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","width":250,"display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="ECE391 MP3 Notes about all the documents and materials related to ECE391 MP3.   FA22 Group 11 â€” ZinixOS   Mmebers: Zicheng Ma, Ziyuan Chen, Zhirong Chen, Shihua Zeng   Language: ä¸­æ–‡+English  FA22 ECE39">
<meta property="og:type" content="article">
<meta property="og:title" content="ECE391-MP3-Tutorial">
<meta property="og:url" content="https://zichengma.github.io/ECE391-MP3-Tutorial/index.html">
<meta property="og:site_name" content="Zicheng Ma&#39;s Blog">
<meta property="og:description" content="ECE391 MP3 Notes about all the documents and materials related to ECE391 MP3.   FA22 Group 11 â€” ZinixOS   Mmebers: Zicheng Ma, Ziyuan Chen, Zhirong Chen, Shihua Zeng   Language: ä¸­æ–‡+English  FA22 ECE39">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://zichengma.github.io/ECE391-MP3-Tutorial/Untitled.png">
<meta property="og:image" content="https://zichengma.github.io/ECE391-MP3-Tutorial/Untitled1.png">
<meta property="og:image" content="https://zichengma.github.io/ECE391-MP3-Tutorial/Untitled2.png">
<meta property="og:image" content="https://zichengma.github.io/ECE391-MP3-Tutorial/Untitled3.png">
<meta property="og:image" content="https://zichengma.github.io/ECE391-MP3-Tutorial/Untitled4.png">
<meta property="og:image" content="https://zichengma.github.io/ECE391-MP3-Tutorial/Untitled5.png">
<meta property="og:image" content="https://zichengma.github.io/ECE391-MP3-Tutorial/Untitled6.png">
<meta property="og:image" content="https://zichengma.github.io/ECE391-MP3-Tutorial/Untitled7.png">
<meta property="og:image" content="https://zichengma.github.io/ECE391-MP3-Tutorial/Untitled8.png">
<meta property="og:image" content="https://zichengma.github.io/ECE391-MP3-Tutorial/Untitled9.png">
<meta property="og:image" content="https://zichengma.github.io/ECE391-MP3-Tutorial/Untitled10.png">
<meta property="og:image" content="https://zichengma.github.io/ECE391-MP3-Tutorial/Untitled11.png">
<meta property="og:image" content="https://zichengma.github.io/ECE391-MP3-Tutorial/Untitled12.png">
<meta property="og:image" content="https://zichengma.github.io/ECE391-MP3-Tutorial/Untitled.jpeg">
<meta property="og:image" content="https://zichengma.github.io/ECE391-MP3-Tutorial/Untitled13.png">
<meta property="og:image" content="https://zichengma.github.io/ECE391-MP3-Tutorial/Untitled14.png">
<meta property="og:image" content="https://zichengma.github.io/ECE391-MP3-Tutorial/Untitled15.png">
<meta property="og:image" content="https://zichengma.github.io/ECE391-MP3-Tutorial/Untitled16.png">
<meta property="og:image" content="https://zichengma.github.io/ECE391-MP3-Tutorial/Untitled17.png">
<meta property="og:image" content="https://zichengma.github.io/ECE391-MP3-Tutorial/Untitled18.png">
<meta property="og:image" content="https://zichengma.github.io/ECE391-MP3-Tutorial/Untitled19.png">
<meta property="article:published_time" content="2023-01-13T23:37:54.000Z">
<meta property="article:modified_time" content="2023-01-14T02:40:23.257Z">
<meta property="article:author" content="Zicheng Ma">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zichengma.github.io/ECE391-MP3-Tutorial/Untitled.png">

<link rel="canonical" href="https://zichengma.github.io/ECE391-MP3-Tutorial/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>ECE391-MP3-Tutorial | Zicheng Ma's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Zicheng Ma's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/About-me" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-test">

    <a href="/test-page" rel="section"><i class="fa fa-mask fa-fw"></i>Test</a>

  </li>
        <li class="menu-item menu-item-course_notes">

    <a href="/CourseNotes" rel="section"><i class="fa fa-book-open fa-fw"></i>Course Notes</a>

  </li>
        <li class="menu-item menu-item-projects">

    <a href="/Projects" rel="section"><i class="fa fa-code fa-fw"></i>Projects</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://zichengma.github.io/ECE391-MP3-Tutorial/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zicheng Ma">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zicheng Ma's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ECE391-MP3-Tutorial
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-01-13 17:37:54 / Modified: 20:40:23" itemprop="dateCreated datePublished" datetime="2023-01-13T17:37:54-06:00">2023-01-13</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="ECE391-MP3"><a href="#ECE391-MP3" class="headerlink" title="ECE391 MP3"></a>ECE391 MP3</h1><blockquote>
<p><em><strong>Notes about all the documents and materials related to ECE391 MP3.</strong></em></p>
</blockquote>
<blockquote>
<p><em><strong>FA22 Group 11 â€” ZinixOS</strong></em></p>
</blockquote>
<blockquote>
<p>Mmebers: Zicheng Ma, Ziyuan Chen, Zhirong Chen, Shihua Zeng</p>
</blockquote>
<blockquote>
<p>Language: ä¸­æ–‡+English</p>
</blockquote>
<p>FA22 ECE391æœ¬äººæœ€ç»ˆè¯„åˆ†A+ï¼Œä¾§é¢è¡¨æ˜è¿™ç¯‡æ–‡æ¡£åœ¨ä¸€å®šç¨‹åº¦ä¸Šè¿˜æ˜¯å¯ä»¥ä¿¡èµ–çš„ï¼Œè€Œä¸”æœ‰æˆ‘çš„é˜Ÿå‹å¯¹æ–‡æ¡£è¿›è¡ŒæŸ¥æ”¹å’Œè¡¥å……<del><em>ä½†å¦‚æœå†™å‡ºbugï¼Œæœ¬äººæ¦‚ä¸è´Ÿè´£</em></del> ğŸ¤£ ğŸ˜‹</p>
<p>REFERENCE:  OSdevç›¸å…³èµ„æ–™ï¼ŒTA Jerry Wangâ€™s slides</p>
<h1 id="Checkpoint-1"><a href="#Checkpoint-1" class="headerlink" title="Checkpoint 1"></a>Checkpoint 1</h1><h2 id="OS-Booting-GDT-amp-IDT-Setup"><a href="#OS-Booting-GDT-amp-IDT-Setup" class="headerlink" title="OS Booting: GDT &amp; IDT Setup"></a>OS Booting: GDT &amp; IDT Setup</h2><h3 id="GDT"><a href="#GDT" class="headerlink" title="GDT"></a>GDT</h3><p>reference: <a target="_blank" rel="noopener" href="https://wiki.osdev.org/Global_Descriptor_Table">https://wiki.osdev.org/Global_Descriptor_Table</a></p>
<p>åœ¨<code>x86_desc.S</code>ä¸­åˆ›å»º<code>gdt_desc</code>æ ‡è®°ï¼ˆå‚è€ƒ<code>ldt_desc</code>ï¼‰</p>
<ul>
<li>48bytesï¼ŒåŒ…æ‹¬<code>.word</code>é•¿åº¦çš„limitå’Œ<code>.long</code>é•¿åº¦çš„base</li>
</ul>
<p>åœ¨<code>boot.S</code>ä¸­ç”¨<code>lgdt gdt_desc</code>è½½å…¥</p>
<h3 id="IDT"><a href="#IDT" class="headerlink" title="IDT"></a>IDT</h3><p>reference: <a target="_blank" rel="noopener" href="https://wiki.osdev.org/Interrupt_Descriptor_Table">https://wiki.osdev.org/Interrupt_Descriptor_Table</a></p>
<p>åœ¨<code>interrupt.c</code>ä¸­å®šä¹‰handlers</p>
<ul>
<li>å¯¹äºExceptionï¼Œæ‰“å°é”™è¯¯ä¿¡æ¯+æ— é™å¾ªç¯ï¼ˆâ€œè“å±â€ï¼‰<strong>ï¼ˆåç»­ckptä¼šå¤„ç†å¦‚ä½•è·³å‡ºæ— é™å¾ªç¯ï¼‰</strong></li>
<li>å¯¹äºInterruptï¼Œåœ¨å‡½æ•°ä½“ä¸­è°ƒç”¨linkage<strong><strong><strong><strong><strong><strong>ï¼ˆæ— å‚æ•°ï¼‰</strong></strong></strong></strong></strong></strong>ï¼Œåœ¨asmä¸­å®šä¹‰linkageå‡½æ•°ï¼ˆPush all, call handler, pop all, <strong><strong><strong><strong>iret</strong></strong></strong></strong>ï¼‰<ul>
<li>éœ€è¦è°ƒç”¨linkageçš„åŸå› æ˜¯ï¼ŒC functionåœ¨ç»“æŸåé»˜è®¤ä½¿ç”¨retï¼Œè€Œinterruptç»“æŸåéœ€è¦ä»kernelè·³å›åˆ°user spaceï¼Œä½¿ç”¨çš„æ˜¯iretã€‚åˆ©ç”¨asm linkageæ¥å®Œæˆè¿™ä¸€æ­¥è·³è½¬ï¼Œç”¨C functionæ¥å®Œæˆæ¯ä¸ªinterrupt handlerçš„å…·ä½“å·¥ä½œã€‚</li>
</ul>
</li>
<li>åˆ©ç”¨å®šä¹‰å¥½çš„SET_IDT_ENTRYæ¥è®¾ç½®IDTä¸­æŒ‡å‘çš„linkage&#x2F;function</li>
</ul>
<h2 id="Device-and-Interrupt"><a href="#Device-and-Interrupt" class="headerlink" title="Device and Interrupt"></a>Device and Interrupt</h2><hr>
<h3 id="PIC"><a href="#PIC" class="headerlink" title="PIC"></a>PIC</h3><p>reference:<a target="_blank" rel="noopener" href="https://wiki.osdev.org/PIC">https://wiki.osdev.org/PIC</a></p>
<p>PICæ‰€ä½¿ç”¨portä½ç½®</p>
<p><img src="/ECE391-MP3-Tutorial/Untitled.png" alt="Untitled"></p>
<p>åœ¨IDTä¸­ï¼ŒPIC_MASTERä½¿ç”¨<strong>0x20-0x27</strong> vectorå‘¼å«handlerï¼ŒPIC_SLAVEä½¿ç”¨<strong>0x28-0x2F</strong>å‘¼å«handler</p>
<p>PIC_SLAVEé“¾æ¥åˆ°PIC_MASTERçš„<strong>2å·vector</strong></p>
<hr>
<p><em><strong>Initialization:</strong></em></p>
<ol>
<li>maskæ‰æ‰€æœ‰interruptï¼ˆå‘data portä¼ å…¥0xffï¼‰</li>
<li>å…ˆç»™äºˆ0x11 commandï¼Œç„¶åPICä¼šç­‰å¾…æ¥ä¸‹æ¥3ä¸ªä¼ å…¥å‚æ•°è¿›è¡Œåˆå§‹åŒ–ï¼ˆICW1)</li>
<li>æ¥ä¸‹æ¥ç¡®å®šåœ¨IDTä¸­çš„ä½ç½®(ICW2)</li>
<li>å†³å®šMasterå’ŒSlaveçš„cascadeçŠ¶å†µ(ICW3)</li>
<li>æœ€åå‘Data portä¼ å…¥è¿™æ˜¯x86æ¨¡å¼ï¼Œä»¥é€‚é…x86æ¨¡å¼è¿›è¡Œå·¥ä½œ</li>
</ol>
<p>ä¸»è¦å¯¹ç€Lecture10 PPTå†™å³å¯</p>
<hr>
<p><em><strong>enable_irq &#x2F; disable_irq:</strong></em></p>
<p>PICå†…éƒ¨å­˜åœ¨ä¸€ä¸ªregister Interrupt Mask Registerï¼Œå…±8bitï¼Œå½“å¯¹åº”bitä½è¢«setä¸º1æ—¶ï¼ŒPICä¼šå¿½ç•¥å¯¹åº”ä½ç½®irqã€‚æ³¨æ„: maskæ•°å­—é«˜çš„irqä¸ä¼šå½±å“æ•°å­—ä½çš„irqï¼ˆpriorityæ›´é«˜çš„irqï¼‰</p>
<p>å…ˆåˆ¤æ–­irqæ˜¯å¦è¶…è¿‡7ï¼Œè‹¥è¶…è¿‡7ï¼Œå‘PIC_SLAVEçš„data portä¼ å…¥æ•°æ®ï¼Œå¦åˆ™å‘PIC_MASTERdata portä¼ å…¥æ•°æ®</p>
<img src="/ECE391-MP3-Tutorial/Untitled1.png" alt="Untitled" style="zoom:50%;">

<img src="/ECE391-MP3-Tutorial/Untitled2.png" alt="Untitled" style="zoom:50%;">

<hr>
<p><em><strong>send_EOI:</strong></em></p>
<p>åŒæ ·éœ€è¦æ£€æŸ¥irq numberã€‚æ— è®ºå¦‚ä½•éƒ½è¦ç»™MASTER command port send EOIï¼Œå¦‚æœæ˜¯SLAVEçš„handlerç»“æŸï¼Œé‚£å°±ç»™SLAVEä¹Ÿè¡¥ä¸Š</p>
<p>æ³¨æ„: æˆ‘ä»¬çš„ä»£ç ä¸­EOIåœ¨sendä¹‹å‰éœ€è¦å’Œirqåšä¸€ä¸ªORæ“ä½œï¼Œä»¥å‘ŠçŸ¥PICæ˜¯å“ªä¸€ä¸ªirqç»“æŸ</p>
<p><img src="/ECE391-MP3-Tutorial/Untitled3.png" alt="Untitled"></p>
<p>è¡¥å……ï¼šä»¥ä¸Šå‡½æ•°å‡éœ€è¦åš<strong>sanity check</strong>ï¼Œä¸å…è®¸ä¼ å…¥çš„irq numberæ˜¯ä¸€ä¸ª0-15ä»¥å¤–çš„æ•°å€¼</p>
<hr>
<h3 id="RTC"><a href="#RTC" class="headerlink" title="RTC"></a>RTC</h3><p>RTCå¯ä»¥ä»¥å¤šä¸ªé¢‘ç‡è¿è¡Œï¼ŒåŸºç¡€é¢‘ç‡32.768kHzï¼Œå¯ä»¥ç”¨divider registeræ”¹å˜ï¼Œä½†æ˜¯ä¸è¦å˜ï¼Œè¦ä¸ç„¶ä¸å‡†ã€‚å¯¹äºinterruptï¼Œé»˜è®¤äº§ç”Ÿinterruptçš„é¢‘ç‡æ˜¯1024Hzï¼Œå¯ä»¥è‡ªè¡Œä¿®æ”¹ï¼Œthe RTC can theoretically generate **15 interrupt rates between 2 Hz and 32768 Hz (**2^1-2^15)</p>
<p>RTC handleræœŸé—´ï¼Œç¦ç”¨NMIï¼Œå¦åˆ™å¯¼è‡´RTCå˜æˆä¸å¯ç”¨çŠ¶æ€</p>
<p>RTCä½¿ç”¨<strong>port 0x70å’Œ0x71</strong>ï¼Œ0x70ç”¨æ¥æŒ‡ç¤ºç”¨å“ªä¸ªregisterï¼Œ0x71åŒ…å«æ•°æ®ã€‚åœ¨é€‰æ‹©registeræ—¶å¯ä»¥é¡ºå¸¦maskæ‰NMI</p>
<p><img src="/ECE391-MP3-Tutorial/Untitled4.png" alt="Untitled"></p>
<hr>
<p><em><strong>Initialization:</strong></em></p>
<ol>
<li>æ‰“å¼€IRQ8  è¿™é‡ŒresetåŸå› æ˜¯æ¯æ¬¡è¯»å†™å®Œä¹‹åï¼Œport 0x70çš„å†…å®¹éƒ½ä¼šè¢«æ¸…é›¶ï¼Œéœ€è¦é‡æ–°æŒ‡å®šregisterï¼Œç„¶ååœ¨è¿™ä¹‹åè¦<code>enable_irq(8)</code></li>
</ol>
<p><img src="/ECE391-MP3-Tutorial/Untitled5.png" alt="Untitled"></p>
<ol>
<li><p>é€‰æ‹©interruptäº§ç”Ÿçš„frequency</p>
<p> å¯„å­˜å™¨Açš„ä½4ä½ï¼Œæ˜¯divider valueï¼Œé»˜è®¤ä½0110å³6ï¼Œæ‰€ä»¥é»˜è®¤frequency &#x3D; 2^15&gt;&gt;(6-1) &#x3D; 1024</p>
<p> è®¾ç½®å¥½å¯„å­˜å™¨Açš„ä½4ä½(ç§°ä¸ºrate)åï¼Œæœ€ç»ˆ<strong>frequency &#x3D; 2^15 &gt;&gt;(rate-1)</strong></p>
<p> <strong>rateæœ€ä½åªèƒ½é€‰3</strong>ï¼Œä½äº3ä¼šroll overï¼Œå¯¼è‡´interrupté¢‘ç‡ä¸å‡†</p>
<p> <img src="/ECE391-MP3-Tutorial/Untitled6.png" alt="Untitled"></p>
</li>
</ol>
<hr>
<p><em><strong>handler:</strong></em></p>
<p>éœ€è¦ä½¿ç”¨ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå¹¶ä¸”éœ€è¦volatileï¼Œæ¥è®°å½•RTCäº§ç”Ÿinterruptçš„æ¬¡æ•°ï¼Œå½“åšæ—¶é’Ÿ</p>
<p>è¿™ä¸ªæ•°å­—ï¼Œé™¤ä»¥frequencyï¼Œå°±å¯ä»¥å¾—åˆ°å½“å‰è¿‡äº†å¤šå°‘ç§’ï¼Œæˆ–è€…å¤šå°‘ms</p>
<ol>
<li><p><strong>if register C is not read after an IRQ 8, then the interrupt will not happen again</strong></p>
<p> åœ¨æ¯æ¬¡handlerä¹‹åéœ€è¦åŠ å…¥ä¸€æ®µ</p>
<p> <img src="/ECE391-MP3-Tutorial/Untitled7.png" alt="Untitled"></p>
</li>
<li><p>ç„¶åsend_EOIï¼ŒSTI</p>
</li>
</ol>
<hr>
<h3 id="Keyboard"><a href="#Keyboard" class="headerlink" title="Keyboard"></a>Keyboard</h3><p>é”®ç›˜æœ¬èº«å±äºPS&#x2F;2 controllerï¼Œä½¿ç”¨PS&#x2F;2çš„portã€‚è¯»å–é”®ç›˜å†…å®¹ä»<strong>0x60</strong>ç«¯å£è·å¾—ï¼Œ<strong>connect to irq1</strong></p>
<p><img src="/ECE391-MP3-Tutorial/Untitled8.png" alt="Untitled"></p>
<p>commandä¸ºä¸€ä¸ªbyteï¼Œé”®ç›˜ä¼šresponse â€œACKâ€ (to acknowledge the command) or a â€œResendâ€ (to say something was wrong with the previous command)</p>
<p>scan code setä¼šè¡¨ç¤ºå“ªä¸ªé”®è¢«ä¸‹å‹ã€‚scan codeå¯èƒ½ä¸æ­¢ä¸€ä¸ªï¼Œæœ€å¤š6ä¸ªbytesã€‚å½“keyboardçŠ¶æ€æœºçŸ¥é“ç°åœ¨scan codeå·²ç»å…¨éƒ¨è·å–äº†ï¼Œå°±å¯ä»¥å°†å…¶è½¬åŒ–æˆkey codeäº†ã€‚</p>
<p>æˆ‘ä»¬çš„é”®ç›˜å±äºUS QWERTYï¼Œç”¨SCAN CODE SET1</p>
<p><em><strong>Initialization:</strong></em></p>
<p>åªéœ€è¦enable_irqå³å¯</p>
<p><em><strong>handler:</strong></em></p>
<ol>
<li>ä»portä¸­è¯»å–æ•°æ®   <code>inb(0x60)</code></li>
<li>åˆ©ç”¨æå‰å»ºå¥½çš„tableå¯¹åº”ASCII<ol>
<li>æ£€æµ‹æ˜¯å¦ä¸ºç‰¹æ®Šé”® shift capsâ€¦.   å¦‚æœæ˜¯ï¼Œæš‚æ—¶ä¸åšä»»ä½•æ“ä½œï¼ˆæˆ–è€…å¯ä»¥åœ¨è¿™ä¸ªckptå°±æŠŠè¿™ä¸ªä¸œè¥¿å¼„å¥½ï¼‰</li>
<li>å¯¹æ™®é€šé”®ï¼Œå¯¹åº”ASCIIç å¹¶putc</li>
</ol>
</li>
<li>send EOI</li>
</ol>
<h2 id="Paging"><a href="#Paging" class="headerlink" title="Paging"></a>Paging</h2><p>reference: <a target="_blank" rel="noopener" href="https://wiki.osdev.org/Paging">https://wiki.osdev.org/Paging</a></p>
<h3 id="kernel-c"><a href="#kernel-c" class="headerlink" title="kernel.c"></a>kernel.c</h3><p>åœ¨ <code>kernel.c</code> çš„ <code>entry</code>å‡½æ•°ä¸­æ·»åŠ  <code>page_init</code>å‡½æ•°ï¼Œ è°ƒç”¨ <code>page.c</code>ä¸­åˆå§‹åŒ–åˆ†é¡µçš„ä»£ç </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Init the PIC */</span></span><br><span class="line">	i8259_init();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Init paging */</span></span><br><span class="line">	page_init();</span><br></pre></td></tr></table></figure>

<h3 id="page-c-page-h"><a href="#page-c-page-h" class="headerlink" title="page.c, page.h"></a>page.c, page.h</h3><ol>
<li><p>åœ¨æ–°æ–‡ä»¶ <code>page.h</code> ä»¥åŠ <code>page.c</code> ä¸­å®šä¹‰ç›¸å…³å‡½æ•°å’Œæ•°æ®ç»“æ„</p>
<ul>
<li>page tableéœ€è¦è‡ªå®šä¹‰æ•°æ®ç»“æ„ï¼Œå‚ç…§OSdevæˆ–è€…x86æ‰‹å†Œ</li>
</ul>
</li>
<li><p>å®šä¹‰å‡½æ•°</p>
<ul>
<li>éœ€è¦å®Œæˆå¯¹ <strong>page directory table</strong> å’Œ ä¸¤ä¸ª <strong>page table</strong> çš„åˆå§‹åŒ–ï¼Œå¹¶ä¸”å†™å…¥å†…å­˜ä¸­å¯¹åº”ä½ç½®ã€‚page initéƒ¨åˆ†å®é™…ä¸Šå°±æ˜¯ä¿®æ”¹åˆ›å»ºå¥½çš„page tablesä¸­å„ä¸ªbitçš„å€¼ï¼Œå¯¹åº”æ‰€éœ€è¦å¼€å¯çš„pagingéƒ¨åˆ†</li>
<li>éœ€è¦æ“ä½œ CPU çš„ <code>cr0</code>, <code>cr3</code>, <code>cr4</code> å¯„å­˜å™¨ï¼Œå‘ŠçŸ¥ç¡¬ä»¶page directoryçš„ä½ç½®å¹¶ä¸º paging å¼€å¯ç¡¬ä»¶æ”¯æŒã€‚è¿™ä¸€æ­¥ç›¸å½“äºæ¿€æ´»ä¸Šé¢ä¸€æ­¥åˆå§‹åŒ–å¥½çš„page directoryå’Œpage table</li>
<li>cr0ç”¨äºå¼€å¯paging         cr4ç”¨äºå¼€å¯4MB page        cr3ä¸ºTLBï¼Œå³æŒ‡ç¤ºpage directoryä½ç½®</li>
</ul>
<p> page directory entry å’Œ page table entry çš„ç»“æ„ï¼š</p>
<p> <img src="/ECE391-MP3-Tutorial/Untitled9.png" alt="Untitled"></p>
</li>
</ol>
<h1 id="Checkpoint-2"><a href="#Checkpoint-2" class="headerlink" title="Checkpoint 2"></a>Checkpoint 2</h1><h2 id="Terminal-Driver"><a href="#Terminal-Driver" class="headerlink" title="Terminal Driver"></a>Terminal Driver</h2><hr>
<p>ToDo:</p>
<ol>
<li>å®Œå–„é”®ç›˜æ˜ å°„ï¼šShiftã€CapsLockï¼ˆCtrlå’ŒAltä¹Ÿéœ€è¦ç”¨å…¨å±€å˜é‡è¿½è¸ªï¼Œæš‚æ—¶æ²¡æœ‰æ›´å¤šä½œç”¨â€”â€”TAï¼‰</li>
<li>å…‰æ ‡è¿½è¸ªï¼šè®©æ‰“çš„å­—å‡ºç°åœ¨å…‰æ ‡å¤„ï¼Œéœ€è¦æ”¯æŒä¸Šä¸‹æ»‘åŠ¨ï¼ˆå…¶å®åªæœ‰å‘ä¸Šï¼›å¯ä»¥ä¸ç”¨ä¿ç•™command historyï¼‰ã€‚è¿˜éœ€è¦æ”¯æŒCtrl+L&#x2F;Ctrl+lçš„æ¸…å±æ“ä½œ</li>
<li>è¿˜éœ€è¦æ”¯æŒé€€æ ¼é”®ï¼ˆç›´æ¥æ”¹å˜å…‰æ ‡ï¼‰å’Œè¡Œç¼“å†²è¾“å…¥ï¼Œç¼“å†²åŒºå¤§å°128B</li>
</ol>
<p><strong>read:</strong></p>
<p>ä»keyboard bufferä¸­è¯»å–å†™å…¥çš„å­—ç¬¦ï¼Œè½¬ç§»åˆ°terminal bufferä¸­ï¼Œè¿”å›è¯»å–çš„bytesæ€»æ•°</p>
<p>è®¾ç½®whileå¾ªç¯ï¼Œä¸æ–­é€šè¿‡é”®ç›˜å‘keyboard bufferä¸­å¢åŠ å†…å®¹ï¼Œæ‰«æåˆ°enteræ‰è¿”å›ã€‚ç¼“å†²åŒºæ¢å…¥127ä¸ªå­—ç¬¦æ—¶ï¼Œæ‹’ç»æ–°è¿›å…¥çš„å­—ç¬¦ï¼ˆåœæ­¢æ›´æ–°ç¼“å†²åŒºï¼‰ï¼Œç­‰å¾…ä¸€ä¸ªenterçš„è¾“å…¥ã€‚ï¼ˆæœ€åä¸€ä¸ªå­—ç¬¦åº”ä¸º\nï¼‰</p>
<p>å¯¹äºterminalï¼Œreadå¤šå°‘å­—ç¬¦ï¼Œå°±æŠŠbufferä¸­çš„å¤šå°‘ä¸ªå­—ç¬¦ç»™æ¸…ç©ºï¼Œå¹¶å°†åé¢çš„æŒªåŠ¨åˆ°å‰é¢æ¥</p>
<p><strong><strong><strong><strong><strong><strong><strong><strong>^ å…¶å®å¯ä»¥ç›´æ¥è¦†å†™</strong></strong></strong></strong></strong></strong></strong></strong></p>
<p>readæœ‰ä¸¤ç§æƒ…å†µä¼šç»ˆæ­¢ï¼Œç¬¬ä¸€ç§æ˜¯readåˆ°æŒ‡å®šbyteæ•°ç›®ï¼Œç¬¬äºŒç§æ˜¯ç¢°åˆ°äº†\nï¼ˆå…¶å®åªæœ‰ä¸€ç§ï¼Ÿï¼‰</p>
<p><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>^ åªåœ¨è¯»åˆ°\næ—¶è¿”å›å³å¯ï¼Œè¶Šç•Œæ—¶ç›´æ¥å¿½ç•¥åé¢çš„å­—ç¬¦</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></p>
<p><strong>write:</strong></p>
<p>ä»ä¼ å…¥çš„bufä¸­è¯»å–æ‰€æœ‰å†…å®¹ï¼Œè½¬ç§»åˆ°å±å¹•ä¸Šï¼Œè¿”å›written bytesæ•°ç›®æˆ–è€…-1</p>
<p><strong>æ³¨æ„éœ€è¦æ»šåŠ¨æ¢è¡Œâ†“çš„æƒ…å†µï¼šæ‰“å°å­—ç¬¦è®¡æ•°è¾¾åˆ°80æ—¶è§¦å‘scrollingå‡½æ•°</strong></p>
<p><strong><strong>scrolling:</strong></strong></p>
<p>å¯èƒ½è¦ä¿®æ”¹putcå‡½æ•°ï¼Œå°†ä¸Šæ–¹æ‰€æœ‰å†…å®¹å‘ä¸Šç§»åŠ¨ä¸€è¡Œï¼ŒæŠŠæœ€åº•ä¸‹ä¸€è¡Œæ¸…ç©ºï¼Œç„¶åå†æ‰“å°æ–°çš„å­—ç¬¦ï¼ˆç›´æ¥æ›´æ–°vmemï¼‰</p>
<p><strong><strong>clear:</strong></strong></p>
<p>lib.cä¸­çš„clearå‡½æ•°åªæœ‰æ¸…ç†video memoryçš„æ“ä½œï¼Œæ²¡æœ‰é‡ç½®ä¸‹ä¸€ä¸ªcharacteråº”è¯¥å‡ºç°çš„ä½ç½®</p>
<p>â†‘ä½†ä»ç„¶æ˜¯å¥½äº‹ï¼Œå·®ç‚¹å°±è¦å†™å¾ªç¯å¾€vmemé‡Œèµ‹é›¶äº†ï¼ˆï¼‰</p>
<h2 id="Read-only-File-system"><a href="#Read-only-File-system" class="headerlink" title="Read-only File system"></a>Read-only File system</h2><hr>
<p>ToDo:</p>
<ol>
<li>open and read a file system image</li>
<li>copy program images into physical memory</li>
</ol>
<h3 id="åŸºæœ¬æ•°æ®ç»“æ„"><a href="#åŸºæœ¬æ•°æ®ç»“æ„" class="headerlink" title="åŸºæœ¬æ•°æ®ç»“æ„"></a><strong><strong><strong><strong>åŸºæœ¬æ•°æ®ç»“æ„</strong></strong></strong></strong></h3><p>æ¯ä¸ªBlock 4kBï¼Œç¬¬ä¸€ä¸ªblockç§°ä¸ºboot blockï¼ŒåŒ…å«file systemçš„æ•´ä½“ç»Ÿè®¡ä¿¡æ¯ï¼ˆdiræ•°é‡ã€inodeæ•°é‡ã€æ•°æ®å—æ•°é‡ï¼‰å’Œæ‰€æœ‰çš„directoryã€‚ç»Ÿè®¡ä¿¡æ¯ã€æ¯ä¸ªdirectoryå‡å æ®64B</p>
<p>ç¬¬ä¸€ä¸ªdirectoryæ€»æ˜¯ä»£è¡¨å½“å‰directoryï¼Œå‘½åä¸º.ï¼ˆä¸€ä¸ªç‚¹ï¼‰ï¼Œæ‰€ä»¥å®é™…ä¸Šæœ€å¤šåªèƒ½æœ‰62ä¸ªå…¶ä»–files</p>
<p>æ¯ä¸€ä¸ªdirectoryåŒ…å«ï¼š32Bæ–‡ä»¶åï¼ˆä¸ä¸€å®šè¦åŒ…å«EOSï¼Œä¹Ÿå³æœªå¿…æœ‰â€\0â€æ ‡è®°å­—ç¬¦ä¸²å°¾ï¼‰ã€4Bæ–‡ä»¶ç±»å‹ã€4B inodeç´¢å¼•</p>
<p><img src="/ECE391-MP3-Tutorial/Untitled10.png" alt="Untitled"></p>
<p>file type 0 ä»£è¡¨user levelå¯ä»¥è§¦ç¢°çš„RTCï¼Œ1 for directoryï¼Œ2 for regular fileã€‚å¯¹äºRTCå’Œdirectoryï¼Œ#inodeæ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚</p>
<p><img src="/ECE391-MP3-Tutorial/Untitled11.png" alt="Untitled"></p>
<p>ä»¥ä¸Šä¸‰ä¸ªå‡½æ•°éƒ½æ˜¯å¤±è´¥return -1ï¼ˆfnameä¸å­˜åœ¨&#x2F;indexä¸åˆæ³•&#x2F;#inodeä¸åˆæ³•&#x2F;inodeä¸­æ•°æ®å—ç´¢å¼•ä¸åˆæ³•ï¼‰ã€‚å‰ä¸¤ä¸ªå‡½æ•°æˆåŠŸéƒ½ä¼šå°†dentryæŒ‡é’ˆèµ‹å€¼æˆæ‰€éœ€è¦çš„é‚£ä¸ªdirectoryæ•°æ®ï¼Œç¬¬ä¸‰ä¸ªå‡½æ•°ç›¸å½“äºâ€œreadâ€è¿™ä¸€system callï¼Œè¿”å›è¯»å–äº†å¤šå°‘ä¸ªbyte</p>
<hr>
<p><strong><strong><strong><strong><strong><strong>ä¸Taskçš„è”åŠ¨ï¼š</strong></strong></strong></strong></strong></strong></p>
<p>æ¯ä¸€ä¸ªtaskæœ€å¤šå¼€å¯8ä¸ªfileï¼Œå®ƒä»¬è¢«å­˜åœ¨ä¸€ä¸ªfile arrayä¸­ï¼Œè€Œfile descriptorå°±æ˜¯ç”¨æ¥åœ¨arrayä¸­æ‰¾å¯»è¿™äº›fileçš„ã€‚file arrayä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½åº”è¯¥å‚¨å­˜ä»¥ä¸‹å››ç§ä¿¡æ¯</p>
<ol>
<li>å¯¹åº”è¿™ä¸ªfileçš„å„ç§æ“ä½œå‡½æ•°ï¼Œ<strong>open, read, write, and close</strong> to perform type-specific actions for each operation.</li>
<li>inode numberï¼Œå¯¹äºdirectoryæˆ–è€…RTCå°±æ˜¯0</li>
<li>file positionï¼ŒæŒ‡ç¤ºç”¨æˆ·åœ¨ä»€ä¹ˆä½ç½®å¼€å¯äº†è¿™ä¸ªfileï¼Œç”±read system callæ›´æ–°</li>
<li>flagï¼Œç”¨æ¥æŒ‡ç¤ºå½“å‰descriptoræ­£åœ¨ä½¿ç”¨</li>
</ol>
<p><img src="/ECE391-MP3-Tutorial/Untitled12.png" alt="Untitled"></p>
<p>open a fileçš„æµç¨‹ï¼šå‚¨å­˜å¯¹åº”çš„jump table pointerï¼Œå°†flagè®¾ç½®æˆin-use</p>
<hr>
<h3 id="filesystem-init"><a href="#filesystem-init" class="headerlink" title="filesystem_init"></a><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>filesystem_init</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></h3><ol>
<li><p>æ‰¾åˆ°File imgçš„å¼€å¤´åœ°å€ï¼ŒFileçš„æ‰€æœ‰ä¿¡æ¯åœ¨bootçš„æ—¶å€™å°±å·²ç»å¸®æˆ‘ä»¬å‚¨å­˜åœ¨äº†å†…å­˜çš„æŸä¸€ä¸ªåœ°æ–¹</p>
<p> æ ¹æ®æ–‡æ¡£ï¼Œæ¯ä¸€ä¸ªimgéƒ½ç®—æ˜¯ä¸€ä¸ªmoduleï¼Œå¯ä»¥loadè¿›å»</p>
<p> <img src="/ECE391-MP3-Tutorial/Untitled.jpeg" alt="Untitled"></p>
<p> <img src="/ECE391-MP3-Tutorial/Untitled13.png" alt="Untitled"></p>
</li>
<li><p>åœ¨<code>kernel.c</code>é‡Œè¿›è¡Œfile systemåˆå§‹åŒ–ï¼Œå°†ä¸Šé¢æ‰¾åˆ°çš„æŒ‡é’ˆä¼ é€’ç»™file system</p>
</li>
<li><p>ä¼ å…¥çš„åœ°å€æ˜¯boot_blcokçš„å¼€å¤´ï¼Œç›´æ¥å°†ä¸€ä¸ªå…¨å±€å˜é‡boot_block_ptræŒ‡å‘è¿™ä¸ªåœ°æ–¹</p>
</li>
<li><p>boot_blockä¸­çš„3ä¸ªnumä¿¡æ¯ï¼Œèµ‹å€¼ç»™3ä¸ªå…¨å±€å˜é‡ï¼Œç”¨äºå‚¨å­˜æœ‰å¤šå°‘ä¸ªdirectoryï¼Œæœ‰å¤šå°‘ä¸ªinodeï¼Œæœ‰å¤šå°‘ä¸ªdata_block</p>
</li>
<li><p>æ ¹æ®å„ä¸ªæ•°å­—ï¼Œæ‰¾åˆ°inodeçš„å¼€å¤´å’Œdata_blockçš„å¼€å¤´ï¼Œå¹¶å°†è¿™ä¸¤ä¸ªåœ°å€å‚¨å­˜åœ¨å¦å¤–ä¸¤ä¸ªpträ¸­ï¼Œä»¥å¤‡åç»­ä½¿ç”¨</p>
</li>
</ol>
<p> tipsï¼šå› ä¸ºæ–‡ä»¶ç³»ç»Ÿåªè¯»ä¸å†™ï¼Œå¯ä»¥ç”¨é™æ€çš„å…¨å±€å˜é‡å‚¨å­˜è¿™äº›æ‰€æœ‰ä¿¡æ¯</p>
<hr>
<h3 id="Three-base-functions"><a href="#Three-base-functions" class="headerlink" title="Three base functions"></a>Three base functions</h3><p><strong><strong>read_dentry_by_index:</strong></strong></p>
<ol>
<li>sanity checkï¼Œå¦‚æœindexè¶…å‡ºdir_numï¼Œreturn -1</li>
<li>å°†boot_blockä¸­çš„<code>dentries[index]</code>å€¼èµ‹ç»™ä¼ å…¥çš„dentryæŒ‡é’ˆ<ol>
<li>èµ‹å€¼è¿‡ç¨‹ä¸­ï¼Œfilenameå¿…é¡»ç”¨<code>lib.c</code>æä¾›çš„<code>strncpy</code>ï¼Œå› ä¸ºfilenameå…è®¸æ²¡æœ‰stringç»“å°¾ç¬¦<code>\0</code></li>
</ol>
</li>
</ol>
<p><strong><strong>read_dentry_by_name:</strong></strong></p>
<ol>
<li>è®¾ç½®ä¸€ä¸ªindexå˜é‡ï¼Œéå†æ‰€æœ‰åœ¨boot_blockçš„file nameï¼Œæ¯æ¬¡index++</li>
<li>index++ä¹‹ååšcheckï¼Œå¦‚æœå·²ç»è¶…å‡ºdir_numï¼Œreturn -1</li>
<li>å¦‚æœåŒ¹é…åˆ°ï¼ˆåˆ©ç”¨<code>lib.c</code>ä¸­æä¾›çš„<code>strncmp</code>ï¼‰ï¼Œå‘¼å«<code>read_dentry_by_index(index, dentry)</code>ï¼Œè®©read_dentry_by_indexå®ŒæˆçœŸæ­£çš„èµ‹å€¼æ“ä½œ</li>
</ol>
<p><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>read_data:</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></p>
<ol>
<li>sanity checkï¼Œç¡®è®¤(fileæ€»é•¿åº¦-offset)&gt;0 å¹¶ä¸” inode_index &lt; boot_blockæ‹¥æœ‰çš„inodeæ•°ç›®-1</li>
<li>æ‰¾åˆ°å¯¹åº”çš„inodeï¼Œ<code>inodes_arr[i]</code></li>
<li>è®¡ç®—éœ€è¦ä»å“ªä¸ªdata_blockçš„å“ªä¸ªä½ç½®å¼€å§‹è¯»å– offset &#x2F; block_size  +  offset % block_size</li>
<li>è®¡ç®—è¯»å–åˆ°å“ªä¸ªdata_blockçš„å“ªä¸ªä½ç½®</li>
<li>å¼€å§‹å¾ªç¯å¤åˆ¶æ•°æ®åˆ°buffä¸­ï¼ŒåŒæ—¶è¦æ£€æµ‹æ˜¯å¦éœ€è¦æ›´æ¢å¦ä¸€ä¸ªdata_block</li>
</ol>
<hr>
<p>é—®é¢˜ï¼šæˆ‘ä»¬éœ€è¦åœ¨è¿™é‡Œå®ç°file descriptor arrayå—ï¼Ÿæš‚æ—¶ä¸éœ€è¦ï¼Œåœ¨ä¹‹åçš„scheduleréƒ¨åˆ†å‡ºç°äº†task structå†å®ç°</p>
<hr>
<h2 id="The-Real-Time-Clock-Driver"><a href="#The-Real-Time-Clock-Driver" class="headerlink" title="The Real-Time Clock Driver"></a>The Real-Time Clock Driver</h2><p>reference:<a target="_blank" rel="noopener" href="https://wiki.osdev.org/RTC">https://wiki.osdev.org/RTC</a></p>
<p>åšåˆ°å’ŒRTCäº¤äº’ï¼Œè®©userç›´æ¥ä¿®æ”¹å®ƒçš„é¢‘ç‡ï¼Œæœ€å¥½èƒ½<strong>è™šæ‹ŸåŒ–</strong></p>
<p>è™šæ‹ŸåŒ–å¯ä»¥é‡‡ç”¨ä¸€ä¸ªå…¨å±€å˜é‡counterï¼Œæ¯æ¬¡interruptäº§ç”Ÿéƒ½++ï¼Œè¿™é‡Œçš„interruptçœ‹åšæ˜¯ä¸€ä¸ªåŸºç¡€interruptï¼Œé‡‡å–æœ€é«˜é¢‘ç‡ï¼Œå³1024Hz</p>
<p>å¯¹äºä¸åŒé¢‘ç‡ï¼Œå¦‚æœcounterè‡ªè¿™ä¸ªreadå‡½æ•°è¢«åˆ›å»ºåè¿‡äº† 1024&#x2F;frequencyæ¬¡ï¼Œåˆ™return</p>
<p>ä¾‹å¦‚ï¼šè™šæ‹ŸåŒ–çš„RTC_readéœ€è¦ä¸€ä¸ª512Hzçš„RTCï¼Œé‚£ä¹ˆè¿‡äº†1024&#x2F;512&#x3D;2ä¸ªinterruptåreturn</p>
<p>å¯èƒ½éœ€è¦ä¸€ä¸ªarrayï¼Œå…¨éƒ¨entriesåˆå§‹åŒ–ä¸º1ï¼Œå¯¹ä¸åŒçš„è™šæ‹Ÿçš„RTC deviceå‚¨å­˜å„è‡ªçš„é¢‘ç‡ï¼Œinterruptå®é™…ä¸Šåªæ”¹å˜counterã€‚åœ¨åç»­ckptä¸­ï¼Œæœ‰å¤šä¸ªterminalï¼Œæ¯ä¸€ä¸ªterminalä¸Šæ‰§è¡Œçš„ç¨‹åºå¯èƒ½ä¼šè®¾ç½®ä¸åŒçš„RTCé¢‘ç‡ï¼Œå¯¹åº”è¿™ä¸ªarrayä¸­çš„ä¸€ä¸ªfreq</p>
<p><strong>open:</strong></p>
<p>å°†freqæ”¹ä¸º2Hzï¼Œè¿”å›0ã€‚flagè®¾ç½®ä¸º0ã€‚åç»­åˆ°äº†å¤šè¿›ç¨‹æ—¶ï¼Œfreqå’Œflagéƒ½æœ‰å¤šä¸ªï¼Œæ¯ä¸ªè¿›ç¨‹å¯¹åº”ä¸€å¯¹freqå’Œflagã€‚</p>
<p><strong>close:</strong></p>
<p>è¿”å›0ï¼ˆæ–‡æ¡£å¦‚æ­¤ï¼‰</p>
<p><strong>read:</strong></p>
<p>è·Ÿè¸ªå…¨å±€flagï¼Œç”¨ä¸€ä¸ªwhile loopè®©readå‡½æ•°é™·å…¥å¾ªç¯ï¼Œç›´åˆ°flagè¢«è®¾ç½®æˆ1ï¼Œè·³å‡ºå¾ªç¯ã€‚è·³å‡ºæ—¶å†é‡æ–°å°†flagè®¾ç½®ä¸º0ï¼Œreturnã€‚è¿™æ ·å¯ä»¥è¾¾åˆ°ä¸€ç§ç±»ä¼¼äºlinuxä¸­sleepçš„æ•ˆæœã€‚</p>
<p><strong><strong><strong><strong><strong><strong>write:</strong></strong></strong></strong></strong></strong></p>
<p>å…ˆåšsanity checkï¼Œå¦‚æœéƒ½é€šè¿‡ï¼Œæ ¹æ®ä¼ å…¥çš„frequencyè®¾ç½®freqã€‚æ­¤æ—¶æš‚æ—¶åªæœ‰ä¸€ä¸ªterminalï¼Œæ²¡æœ‰è¿›ç¨‹ä¹‹é—´çš„åˆ‡æ¢ï¼Œåœ¨åç»­ckptä¸­éœ€è¦æ£€æŸ¥å½“å‰writeæŒ‡ä»¤æ˜¯ç”±å“ªä¸€ä¸ªè¿›ç¨‹è°ƒç”¨çš„ï¼Œä¿®æ”¹è¿™ä¸ªè¿›ç¨‹å¯¹åº”çš„freq</p>
<p><strong>handler:</strong></p>
<p>ä½¿counter++ï¼Œæ£€æŸ¥æ˜¯å¦åº¦è¿‡äº†freqä¸ªå•ä½æ—¶é—´ï¼Œå¦‚æœæ˜¯ï¼Œå°†flagè®¾ç½®ä¸º1ã€‚è®¾ç½®ä¸º1çš„æ—¶å€™ï¼Œä¹‹å‰æŸæ¬¡è°ƒç”¨çš„readå‡½æ•°å°±ä¼šè¿”å›ã€‚</p>
<p>å…·ä½“ç›¸å…³ç«¯å£ï¼Œå¯¹rtcçš„äº¤äº’è¯·æŸ¥çœ‹referenceï¼ˆOSdevï¼‰</p>
<hr>
<h1 id="Checkpoint-3"><a href="#Checkpoint-3" class="headerlink" title="Checkpoint 3"></a>Checkpoint 3</h1><h2 id="System-Calls"><a href="#System-Calls" class="headerlink" title="System Calls"></a>System Calls</h2><p>int $0x80å‘¼å«ï¼Œæœ€å¤šæ¥å—ä¸‰ä¸ªå‚æ•°</p>
<p>call number, arg1, arg2, arg3 â†’ EAX, EBX, ECX, EDX</p>
<p>æˆåŠŸreturn 0ï¼Œå¤±è´¥return -1ï¼Œè¿”å›å€¼æ”¾åœ¨EAX</p>
<p>ä¸€éƒ¨åˆ†ä¸ä¼šè¿”å›ï¼ˆå¦‚haltï¼‰</p>
<p><strong>open</strong></p>
<p>åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æ‰¾åˆ°æ–‡ä»¶ï¼Œåˆ†é…ä¸€ä¸ªç©ºé—²çš„æè¿°ç¬¦å¹¶åˆå§‹åŒ–ï¼ˆæ³¨æ„æ–‡ä»¶ç±»å‹ï¼‰</p>
<p><strong>close</strong></p>
<p>æ£€æµ‹æè¿°ç¬¦åˆæ³•æ€§ï¼Œåé‡Šæ”¾æè¿°ç¬¦</p>
<p><strong>read</strong></p>
<p>ä»RTC&#x2F;é”®ç›˜&#x2F;æ–‡ä»¶&#x2F;ç›®å½•è¯»å–æ•°æ®ï¼Œè¿”å›è¯»å–çš„bytesæ•°é‡</p>
<p>RTCï¼šæ¥æ”¶åˆ°virtual interruptæ—¶è¿”å›0</p>
<p>é”®ç›˜ï¼šè¯»å–åˆ°\næ—¶ æˆ– bufferæ»¡æ—¶è¿”å›</p>
<p>æ–‡ä»¶ï¼šè¯»å–åˆ°EOFæ—¶ æˆ– bufferæ»¡æ—¶è¿”å›</p>
<p>File PositionæŒ‡è¯»å–ä½ç½®</p>
<p>system callçš„ä¼ å…¥å‚æ•°æ€§è´¨ä¹Ÿå†³å®šäº†æˆ‘ä»¬éœ€è¦ä¸ºå®ƒä»¬ç¼–å†™ä¸€ä¸ªwrapper(link)æ¥ä¿è¯å‚æ•°æ­£å¸¸ä¼ é€’</p>
<hr>
<h3 id="Wrapper-amp-Linkage"><a href="#Wrapper-amp-Linkage" class="headerlink" title="Wrapper &amp; Linkage"></a>Wrapper &amp; Linkage</h3><p>éœ€è¦å®ç°çš„10ä¸ªsystem callæœ€å¤šåªæœ‰ä¸‰ä¸ªå‚æ•°ï¼Œç”¨asmå†™wrapper <strong>ï¼ˆè¿™éƒ¨åˆ†å¹¶ä¸å½’æˆ‘ä»¬å†™ï¼Œæä¾›çš„å¯æ‰§è¡Œæ–‡ä»¶åŒ…å«äº†è¿™éƒ¨åˆ†wrapperï¼‰</strong></p>
<p>åœ¨IDTçš„0x80å·ä½ç½®è°ƒç”¨åŒ…è£…å‡½æ•°</p>
<ol>
<li>callee saved</li>
<li>è·å–argumentsï¼Œæ ¹æ®æ•°ç›®ä¸åŒä»EBX, ECX, EDXä¸­è·å–</li>
<li>è·å–system call numberï¼Œ<code>int 0x80</code></li>
<li>restore callee saved</li>
</ol>
<hr>
<h3 id="System-call-handler"><a href="#System-call-handler" class="headerlink" title="System call handler"></a>System call handler</h3><ol>
<li><p>save all registers</p>
</li>
<li><p>check system call number is valid or not</p>
</li>
<li><p>åˆ©ç”¨å·²æœ‰çš„function tableæ‰¾åˆ°å¯¹åº”system callï¼Œä»callä¹‹åçš„stackæ¥çœ‹ï¼Œè·å–å‚æ•°åº”è¯¥åœ¨æ¯ä¸€ä¸ªsystem callæ‰€å¯¹åº”çš„å‡½æ•°ä¹‹å†…  â€” é—®é¢˜ï¼šå¦‚ä½•è®©ä¸€ä¸ªC functionç›´æ¥ä»å¯„å­˜å™¨ä¸­è¯»å–æ•°å€¼ï¼Œfastcallï¼Ÿ</p>
<p> æˆ–è€…<strong>å¦ä¸€ç§è§£å†³åŠæ³•ï¼Œç›´æ¥åœ¨system call handlerä¸­æ¢å¤C convention</strong></p>
<p> <img src="/ECE391-MP3-Tutorial/Untitled14.png" alt="Untitled"></p>
</li>
<li><p>æ£€æŸ¥è¿”å›å€¼ï¼Œå¤±è´¥ä¸æˆåŠŸ</p>
</li>
<li><p>restore register</p>
</li>
<li><p>é‡æ–°è®¾ç½®å…³äºiretæ‰€éœ€è¦çš„ä¸€åˆ‡</p>
</li>
<li><p>iret</p>
</li>
</ol>
<hr>
<h3 id="Execute-sys-callå…·ä½“æµç¨‹"><a href="#Execute-sys-callå…·ä½“æµç¨‹" class="headerlink" title="Execute sys callå…·ä½“æµç¨‹"></a>Execute sys callå…·ä½“æµç¨‹</h3><p>å°è¯•åŠ è½½ä¸€ä¸ªæ–°çš„ç¨‹åº</p>
<p>æ¥æ”¶å‚æ•°commandï¼ˆå­—ç¬¦ä¸²ï¼‰æ˜¯ä¸€ä¸ªä»¥ç©ºæ ¼ä¸ºåˆ†ç•Œçš„ä¸€è¿ä¸²wordsï¼Œç¬¬ä¸€ä¸ªwordæ˜¯file nameï¼Œä¹‹åçš„éƒ½ç”±getargsè·å¾—</p>
<p>æ— æ³•æ‰§è¡Œï¼ˆå‘½ä»¤ä¸å­˜åœ¨ã€éå¯æ‰§è¡Œæ–‡ä»¶ï¼‰è¿”å›-1ï¼ŒExceptionè¿”å›256ï¼Œhaltè¿”å›0~255çš„å€¼</p>
<p><strong>Parse args</strong></p>
<p>å¯¹äº<strong>file name</strong>ï¼Œç›´æ¥å–å‡ºç¬¬ä¸€ä¸ªç©ºæ ¼ä¹‹å‰çš„æ‰€æœ‰å†…å®¹å³å¯ï¼Œå†™ä¸€ä¸ªloopï¼Œç›´åˆ°char &#x3D;&#x3D; â€™ â€™åœæ­¢</p>
<p>å…¶ä»–çš„argumentsæš‚æ—¶å¥½åƒç”¨ä¸åˆ°</p>
<p><strong>Check file validity</strong></p>
<ol>
<li>åˆ©ç”¨file nameæ£€æŸ¥fileä¸­æ˜¯å¦å­˜åœ¨ä¸€æ ·çš„æ–‡ä»¶ï¼Œåœ¨è¿™é‡Œåˆ©ç”¨<strong>read_dentry_by_name</strong>æ—¶å¯ä»¥æŠŠä¿¡æ¯å­˜åœ¨ä¸€ä¸ªdentryå˜é‡ä¸­ï¼Œæ¥ä¸‹æ¥éœ€è¦ä½¿ç”¨</li>
<li>å†è¯»å–è¿™ä¸ªfileçš„å‰4ä¸ªbytesï¼ˆ<strong>read_data</strong>)ï¼ŒæŸ¥çœ‹å®ƒæ˜¯å¦æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶</li>
<li>åœ¨è¿™é‡Œä¹Ÿå¯ä»¥ç›´æ¥è·å–programç¬¬ä¸€æ¡æŒ‡ä»¤æ‰§è¡Œçš„ä½ç½®ï¼ˆ<strong>read_data</strong>ï¼‰ï¼Œå‚¨å­˜åœ¨å¯æ‰§è¡Œæ–‡ä»¶çš„24-27bytes</li>
</ol>
<p><strong>Create PCBs</strong></p>
<p>å¯»æ‰¾åˆ°pidï¼Œå½“å‰æ˜¯ç¬¬å‡ ä¸ªprocess</p>
<p>ä¸ºPCBåˆ†é…ç©ºé—´ï¼Œåˆå§‹åŒ–ï¼Œè®¾ç½®ä¸ºactiveï¼Œå…¶ä¸­kernel stackæ ¹æ®ä¸åŒçš„pidæœ‰ä¸åŒçš„å€¼</p>
<p>Open File descriptor for stdin&#x2F;stdout</p>
<p><strong>Set up paging</strong></p>
<p>éœ€è¦çŸ¥é“å½“å‰æ˜¯ç¬¬å‡ ä¸ªprocessï¼Œæˆ‘ä»¬åº”è¯¥å¯ä»¥å‡è®¾æœ€å¤šåªæœ‰3ä¸ªprocessï¼ˆåƒPPTä¸Šä¸€æ ·ï¼‰</p>
<p>ç›´æ¥åœ¨Page Directoryä¸­  ( 0x8000000(128MB) &gt;&gt;22 )ï¼Œå³2^5&#x3D;<strong>32ä½ç½®ä¿®æ”¹æ˜ å°„</strong></p>
<p><strong>phy add &#x3D; 0x800000 + pid*4MB</strong>  å°† PD[32]å¯¹åº”çš„4MB pageèµ·å§‹ç‚¹ä¿®æ”¹ä¸º <strong>phy add &gt;&gt;12</strong>å³å¯</p>
<p>è®°å¾—flush tlbï¼Œå³é‡æ–°è½½å…¥ä¸€écr3</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *   set_user_prog_page</span></span><br><span class="line"><span class="comment"> *   Set page for a user program</span></span><br><span class="line"><span class="comment"> *   input: pid -- the pid of the user program</span></span><br><span class="line"><span class="comment"> *   output: None</span></span><br><span class="line"><span class="comment"> *   side effect: Change the paging directory; Change CR3; flush TLB</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<p><strong>Load file(program) into memory</strong></p>
<p>fileçš„èµ·å§‹ç‚¹ä¸ºUSER_CODE 0x8048000</p>
<p><strong>Prepare for context switch</strong></p>
<p>mp3 systemä¸­åªæœ‰ä¸€ä¸ªtssï¼Œå°±æ˜¯åœ¨<code>x86_desc.h</code>ä¸­çš„tsså˜é‡ï¼Œåœ¨å›åˆ°user levelä¹‹å‰ï¼Œtssä¸­çš„ç›¸å…³å‚æ•°éœ€è¦è¢«æ›´æ–°</p>
<p>ä¸éœ€è¦è€ƒè™‘scheduleçš„æƒ…å†µä¸‹ï¼Œåªéœ€è¦æ›´æ”¹tssçš„å€¼å³å¯ï¼Œåœ¨soft multitaskingä¸­ï¼Œtssåªæœ‰ä¸¤ä¸ªå€¼æ˜¯ç›¸å…³çš„ï¼Œ<em><em>æ›´æ”¹SS0ä¸ºkernel dsï¼ŒESP0ä¸ºå½“å‰processçš„stackï¼Œå³8MB-8KB</em>(pid)-1ä¸ªbyteã€</em>*</p>
<aside>
â¡ï¸ esp0æ°¸è¿œæ˜¯8MB-8KB*(pid)-1ï¼Œæ˜¯å› ä¸ºæ¯æ¬¡ä»kernelå›åˆ°user spaceï¼Œkernel stackéƒ½è¢«â€œæ¸…ç©ºâ€ï¼Œstackä¸Šå®é™…çš„æ•°æ®æ²¡æœ‰æ”¹å˜ï¼Œä½†ä¸‹ä¸€æ¬¡å›åˆ°kernel spaceï¼Œä»æ ˆåº•å¼€å§‹ã€‚è¿™æ ·åšçš„åŸå› æ˜¯é˜²æ­¢kernel stack overflow

</aside>

<p><img src="/ECE391-MP3-Tutorial/Untitled15.png" alt="Untitled"></p>
<p>iretéœ€è¦çš„äº”ä¸ªå‚æ•°ï¼š</p>
<ul>
<li>user dsï¼Œç›´æ¥ç”¨x86_desc.hä¸­çš„user dsï¼›</li>
<li>espï¼Œuser stackï¼Œä½äº128MB-132MBè¿™ä¸€æ®µmemoryçš„æœ«å°¾ï¼Œå³132MB-4byteï¼›</li>
<li>eflagï¼Œç›´æ¥æŠŠå½“å‰çš„flag pushè¿›å»å¯è¡Œå—ï¼Ÿ</li>
<li>csï¼Œtssä¸­çš„user csï¼›</li>
<li>eipï¼ŒæŠŠä¸Šé¢å‚¨å­˜çš„user programç¬¬ä¸€æ¡æŒ‡ä»¤å¯¹åº”çš„åœ°å€æ‹¿è¿‡æ¥</li>
</ul>
<hr>
<h3 id="Halt-sys-callå…·ä½“æµ"><a href="#Halt-sys-callå…·ä½“æµ" class="headerlink" title="Halt sys callå…·ä½“æµ"></a>Halt sys callå…·ä½“æµ</h3><p>ç»ˆæ­¢è¿›ç¨‹å¹¶è¿”å›æ¯è¿›ç¨‹</p>
<p>Shell â€”â€executeâ€ syscall (when cmd is typed)â†’ Program</p>
<p>Program â€”â€haltâ€ syscall (when â€œreturnâ€)â†’ Shell</p>
<p>å¾ˆé‡è¦çš„ä¸€ç‚¹ï¼Œå¦‚æœæˆ‘ä»¬è¦æ£€æµ‹æ˜¯å¦exceptionï¼Œéœ€è¦åœ¨åŸæ¥çš„exception while1æ”¹æˆå‘¼å«haltçš„å‡½æ•°</p>
<p>haltçš„æ€»ä½“æ€æƒ³ï¼Œåˆ©ç”¨parent processåœ¨kernel stackä¸Šå­˜å¥½çš„contextæ¥iretï¼Œä»¥æ­¤å›åˆ°parent processçš„user level</p>
<ol>
<li>é¦–å…ˆcheckè¿™æ˜¯å¦æ˜¯exceptionå‘¼å«çš„</li>
<li>å†çœ‹ä¸€ä¸‹æ˜¯å¦æ˜¯shellï¼Œå¦‚æœæ˜¯shellæœ¬èº«å‡ºé—®é¢˜ï¼Œéœ€è¦é‡å¯shellï¼Œå› ä¸ºå®ƒæ˜¯ç¬¬ä¸€ä¸ªprogramï¼Œä¸èƒ½è¢«å®Œå…¨æ€æ­»</li>
<li>å…³é—­file descriptorï¼Œå°†å¼€å¯äº†çš„fileå‡å…³é—­ï¼Œå› ä¸ºå¦‚æœä¸å…³é—­ï¼Œä¹‹åé‡æ–°åˆ©ç”¨è¿™æ®µpcbçš„æ—¶å€™ä¼šå‘ç°è®¸å¤šfileéƒ½æ˜¯â€œå¼€å¯â€çŠ¶æ€</li>
<li>å°†å½“å‰çš„processè®¾ç½®ä¸ºnon-active</li>
<li>æ‰¾åˆ°parentï¼Œå¹¶ä»parentçš„pcbä¸­å–å‡ºä¿¡æ¯ï¼Œå°†pagingè®¾ç½®ä¸ºparent programæ‰€éœ€è¦çš„</li>
<li>å°†tssæ›´æ–°æˆparentçš„ä¿¡æ¯ï¼ŒSS0&#x3D;kernel dsï¼ŒESP0&#x3D;parent kernel stack</li>
<li>å†ä»parent pcbä¸­æ‰¾åˆ°ä¹‹å‰çš„contextä¿¡æ¯ï¼Œå…·ä½“è€Œè¨€ï¼Œæ˜¯ä»parent pcbä¸­é‡æ–°å–å›ä¹‹å‰çš„ebpå’Œespï¼Œä¹‹åå†leave+retå°±ç›¸å½“äºä»executeè¿™ä¸ªsyscallçš„åœ°æ–¹è¿”å›ï¼Œç›´æ¥ç”¨è¿™äº›contextä¿¡æ¯æ¥è¿›è¡Œiret</li>
</ol>
<hr>
<h2 id="Tasks"><a href="#Tasks" class="headerlink" title="Tasks"></a>Tasks</h2><p>æ­¤æ¬¡ä¸ç”¨å®Œæˆschedulerï¼Œä½†éœ€è¦åœ¨æŸä¸€ä¸ªprogramäº§ç”Ÿexceptionæ—¶å›åˆ°shell</p>
<p>æ‰€æœ‰taskså…±äº«ä¸€ä¸ª4MBå†…æ ¸æ€åˆ†é¡µã€‚å¯¹äºä¸€ä¸ªè€Œè¨€ï¼Œå…¶taskæ˜ åƒï¼ˆä»£ç ï¼‰çš„ç‰©ç†åœ°å€æ˜¯å›ºå®šçš„è€Œä¸”æ¯ä¸ªå°äº4MBï¼Œåˆ†é…ä¸€ä¸ªç”¨æˆ·æ€åˆ†é¡µå³å¯ã€‚</p>
<hr>
<h2 id="Loader"><a href="#Loader" class="headerlink" title="Loader"></a>Loader</h2><p>åœ¨æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨ä¸­ï¼Œå°†ç¨‹åºä»£ç ä»éšæœºåˆ†é…&amp;æ’åˆ—ï¼ˆä¹Ÿå³åˆ†æ•£ï¼‰çš„4kB disk blocksæ‹·è´åˆ°è¿ç»­çš„ç‰©ç†åœ°å€ä¸­</p>
<p>æ³¨æ„ç»´æŠ¤æ ˆï¼Œæ‹·è´åœ¨å†…æ ¸æ€æ‰§è¡Œï¼Œæ‹·è´ç»“æŸåè¦å›åˆ°ç”¨æˆ·æ€</p>
<hr>
<h2 id="Executing-User-level-Code"><a href="#Executing-User-level-Code" class="headerlink" title="Executing User-level Code"></a>Executing User-level Code</h2><p>æ³¨æ„å†…æ ¸æ€ç¨‹åºä¸èƒ½è°ƒç”¨ç”¨æˆ·æ€ç¨‹åºï¼Œè¦å®ç°privilege switch</p>
<p>IRETçš„æ­£å¸¸è¿è¡Œè¦æ±‚æä¾›ESP EIP EFLAGS CS SSç­‰å¯„å­˜å™¨å€¼</p>
<p>EIP â†’ ä½äºå¯æ‰§è¡Œæ–‡ä»¶24~27Bçš„entry point</p>
<p>ESP â†’ è½½å…¥å¯æ‰§è¡Œæ–‡ä»¶çš„4MBåˆ†é¡µæœ«å°¾</p>
<p>CS â†’ user code segment</p>
<p>DS â†’ user data segment</p>
<p>SS â†’ user stack segment ï¼ˆæœ‰å£°æ˜å—ï¼Ÿï¼‰</p>
<p>è€Œä¸”éœ€æ”¹å˜TSS</p>
<hr>
<h2 id="Process-Control-Block"><a href="#Process-Control-Block" class="headerlink" title="Process Control Block"></a>Process Control Block</h2><p>éœ€å‚¨å­˜çš„Per-Task StateåŒ…æ‹¬</p>
<p>File arrayï¼ˆè®°å½•å¼€å¯çš„æ–‡ä»¶ï¼‰</p>
<p>Signal information â†’ extra creditå†…å®¹ï¼Œå¯ä»¥ä¸è¯†é—²</p>
<p>Kernel stackï¼ˆæ¯ä¸ª8kBï¼‰</p>
<p>ä¸¤ä¸ªtaskçš„kernel stackåˆ†åˆ«å ç”¨ç¬¬4080<del>4087ã€4088</del>4095kB</p>
<p>parent pid</p>
<p>excute_ebp &#x2F; excute_esp ç”¨äºhalt</p>
<hr>
<h1 id="Checkpoint-4"><a href="#Checkpoint-4" class="headerlink" title="Checkpoint 4"></a>Checkpoint 4</h1><h2 id="getargs"><a href="#getargs" class="headerlink" title="getargs"></a>getargs</h2><p>åœ¨executeå†…è°ƒç”¨</p>
<p>å‚æ•°ï¼ˆä»¥å­—ç¬¦ä¸²çš„å½¢å¼ï¼‰å­˜å‚¨åœ¨PCBï¼Œè£å‰ªï¼ˆå¤´éƒ¨ï¼‰å¯æ‰§è¡Œæ–‡ä»¶å&amp;ç©ºæ ¼ã€ï¼ˆå°¾éƒ¨ï¼‰ç©ºæ ¼</p>
<p>ä¾‹ï¼šåœ¨Shell #0ä¸­è¿è¡Œâ€ cat  arg1   arg2    â€œï¼Œå°†â€arg1   arg2â€å­˜å…¥PCB #1ï¼ˆæ³¨æ„ç©ºæ ¼æ•°é‡ï¼‰</p>
<h3 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h3><p>åœ¨bufä¸­ä¼ å…¥ç”¨æˆ·è¾“å…¥çš„å‘½ä»¤</p>
<p>æ£€æµ‹å¤´éƒ¨ç©ºæ ¼ç»“æŸçš„ä½ç½®ã€å°¾éƒ¨ç©ºæ ¼å¼€å§‹çš„ä½ç½®</p>
<p>å°†ä¸¤ä¸ªä½ç½®ä¹‹é—´çš„argså­—ç¬¦ä¸²æ‹·è´è¿›PCBï¼ˆargsä¹‹é—´å¯ä»¥æœ‰ä»»æ„æ•°é‡ç©ºæ ¼ï¼Œäº¤ç»™user programå¤„ç†ï¼‰</p>
<p>æˆåŠŸè¿”å›0ï¼Œå¤±è´¥ï¼ˆargs****************************************************************************+NULL****************************************************************************å¤ªå¤§&#x2F;æ£€æµ‹ä¸åˆ°argsï¼‰è¿”å›-1</p>
<p>æœ€å¥½æŠŠPCB #0ï¼ˆshellï¼‰çš„argså­—ç¬¦ä¸²è®¾ç½®ä¸ºâ€\0â€</p>
<h2 id="vidmap"><a href="#vidmap" class="headerlink" title="vidmap"></a>vidmap</h2><p>éœ€è¦DPL &#x3D; 0ä»¥è®¿é—®ç‰©ç†å†…å­˜vmemï¼Œå½±å“å®‰å…¨æ€§ã€‚è§£å†³æ–¹æ¡ˆä¸ºå°†vmemæ˜ å°„åˆ°è™šæ‹Ÿå†…å­˜</p>
<p>*screen_startæŒ‡å‘è™šæ‹Ÿå†…å­˜åœ°å€ï¼ˆç”¨æˆ·ç»™å®šï¼‰</p>
<p>åŒé‡æŒ‡é’ˆçš„ä½œç”¨æ˜¯å…è®¸è®¿é—®æ•´ä¸ªæ–°çš„4kB page</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// implimentation</span></span><br><span class="line"><span class="type">uint8_t</span>* screen_start = vidmap();</span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="type">uint_t</span>* screen_start;</span><br><span class="line">vidmap(screen_start);</span><br></pre></td></tr></table></figure>

<h3 id="æ­¥éª¤-1"><a href="#æ­¥éª¤-1" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h3><p>æ£€æŸ¥*screen_startçš„åˆæ³•æ€§ï¼šåº”å¤§äº128MBï¼Œå°äº132MBï¼ˆï¼Ÿï¼‰</p>
<p>ä¿®æ”¹PDå’ŒPTå®ç°mappingï¼Œå°†DPLè®¾ç½®ä¸º3ä¾›ç”¨æˆ·è®¿é—®ï¼ˆï¼Ÿï¼‰</p>
<p>æˆåŠŸè¿”å›<strong>0xB8000</strong>ï¼Œå¤±è´¥è¿”å›-1</p>
<hr>
<h1 id="Checkpoint-5"><a href="#Checkpoint-5" class="headerlink" title="Checkpoint 5"></a>Checkpoint 5</h1><h2 id="Multiple-Terminals"><a href="#Multiple-Terminals" class="headerlink" title="Multiple Terminals"></a>Multiple Terminals</h2><p>3ä¸ªterminalï¼Œæœ€å¤šåŒæ—¶è¿è¡Œ6ä¸ªç¨‹åº</p>
<h3 id="Initialization"><a href="#Initialization" class="headerlink" title="Initialization"></a>Initialization</h3><ul>
<li>Initial bootup: åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶å°±åˆå§‹åŒ–ä¸‰ä¸ªè¿›ç¨‹</li>
<li>After bootup: ç”¨Alt+F1&#x2F;F2&#x2F;F3åˆ‡æ¢ï¼Œå½“ç”¨æˆ·ç¬¬ä¸€æ¬¡æŒ‰ä¸‹ALT+F2&#x2F;F3æ—¶å¼€å¯æ–°çš„terminal</li>
</ul>
<h3 id="Separate-I-x2F-O-buffer"><a href="#Separate-I-x2F-O-buffer" class="headerlink" title="Separate I&#x2F;O buffer"></a>Separate I&#x2F;O buffer</h3><p>æ¯ä¸€ä¸ªterminalç»“æ„ä½“ä¸­å­˜å‚¨ç‹¬ç«‹çš„I&#x2F;O bufferã€å…‰æ ‡ã€æ˜¾ç¤ºå±ä¸Šçš„æ–‡å­—ã€active flag</p>
<p>åœ¨åˆ‡æ¢å‡ºterminalçš„æ—¶å€™å­˜èµ·æ¥ï¼Œåˆ‡æ¢å›æ¥çš„æ—¶å€™é‡æ–°è½½å…¥</p>
<h3 id="Isolation"><a href="#Isolation" class="headerlink" title="Isolation"></a>Isolation</h3><p>é€€å‡ºæŸä¸€ä¸ªterminalçš„shellæ—¶ï¼Œä¸ä¼šç«‹å³é‡å¯ï¼Œç›´åˆ°æŠŠæœ€åä¸€ä¸ªshellä¹Ÿé€€å‡ºæ—¶æ‰éœ€è¦é‡å¯shell</p>
<p>åœ¨haltä¿®æ”¹ä¸€ä¸‹é‡å¯æ¡ä»¶ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯æœ€åä¸€ä¸ªshell</p>
<h3 id="Switch"><a href="#Switch" class="headerlink" title="Switch"></a>Switch</h3><p><img src="/ECE391-MP3-Tutorial/Untitled16.png" alt="multi terminal å†…å­˜ç¤ºæ„å›¾"></p>
<p>multi terminal å†…å­˜ç¤ºæ„å›¾</p>
<p>éœ€è¦æ–°åˆ†é…ä¸‰å—backup video memoryï¼Œç±»ä¼¼build bufferçš„ä½œç”¨ï¼Œæ¯ä¸€å—éƒ½å‚¨å­˜ç€å½“å‰terminalçš„video memoryï¼Œåœ¨åˆ‡æ¢çš„æ—¶å€™è¿›è¡Œè½½å…¥</p>
<h3 id="æ­¥éª¤-2"><a href="#æ­¥éª¤-2" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h3><p>åœ¨<code>terminal.c</code>ä¸­å®šä¹‰<code>void switch_terminal(uint8_t term_index)</code>å‡½æ•°ï¼Œåœ¨<code>keyboard.c</code>ä¸­è°ƒç”¨</p>
<ol>
<li>Sanity checkï¼Œä¼ å…¥indexæ˜¯å¦è¶Šç•Œ</li>
<li>åˆ¤æ–­term_indexæ˜¯å¦ä¸ºå½“å‰current_term_indexï¼ˆå…¨å±€å˜é‡ï¼‰ï¼Œè‹¥æ˜¯åˆ™ç›´æ¥è¿”å›</li>
<li>åˆ‡æ¢æµç¨‹(ä»¥ä»terminal1åˆ‡æ¢åˆ°terminal2ä¸ºä¾‹å­)<ol>
<li>video mapåˆ°current terminalï¼Œå³è®©0xB8000æŒ‡å‘phyiscalçš„0xB8000</li>
<li>å°†å½“å‰vmemå­˜åˆ°å±äºterminal1çš„backupå†…å­˜å—ï¼ˆterm1 video pageï¼‰ä¸­</li>
<li>å°†terminal2çš„backupå†…å­˜å—è½½å…¥vmem</li>
<li>è®¾ç½®å…‰æ ‡ä½ç½®ï¼Œæ­¤æ—¶å±å¹•æ›´æ–°å®Œæˆ</li>
<li>æ›´æ–°å…¨å±€å˜é‡current_term_id</li>
<li>video mapåˆ°å½“å‰æ­£åœ¨scheduleçš„process</li>
</ol>
</li>
</ol>
<p>tips: video mapæŒ‡çš„æ˜¯æ›´æ–°virtual 0xB8000æŒ‡å‘çš„physical memoryæ˜ å°„å…³ç³»ï¼Œä»¥ä¸‹ä¸ºå‡½æ•°çš„æè¿°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*   remap_vidmap_page</span></span><br><span class="line"><span class="comment"> *   Set page for video memory for a specific terminal.</span></span><br><span class="line"><span class="comment"> *   If terminal_id = active one, directly write into physical memory.</span></span><br><span class="line"><span class="comment"> *   If terminal_id != active one, map user video memory to corresponding backup buffer.</span></span><br><span class="line"><span class="comment"> *   input: screen_start -- starting address of the video memory</span></span><br><span class="line"><span class="comment"> *   output: None</span></span><br><span class="line"><span class="comment"> *   side effect: Change the paging directory; Change CR3; flush TLB */</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Scheduling"><a href="#Scheduling" class="headerlink" title="Scheduling"></a>Scheduling</h2><p>è·Ÿè¸ªæ‰€æœ‰æ´»è·ƒçš„taskï¼Œæ¯éš”10-50msè½®æµåˆ‡æ¢æ‰§è¡Œ</p>
<p>è¢«æš‚åœçš„taskä¸åº”è¯¥æ‰“å°ä¿¡æ¯ï¼Œéœ€è¦åŠ¨æ€æ›´æ–°page tableä»¥å°†æ˜¾ç¤ºæ˜ å°„åˆ°0xB8000ä»¥å¤–çš„åœ°æ–¹</p>
<h3 id="PIT"><a href="#PIT" class="headerlink" title="PIT"></a>PIT</h3><p>reference: <a target="_blank" rel="noopener" href="https://wiki.osdev.org/PIT">OSDEV Link for PIT</a></p>
<p>Schedulingä¸­è®¡æ—¶ä½¿ç”¨PITè€ŒéRTCï¼Œå› ä¸ºRTCçš„ä¼˜å…ˆçº§å¤ªä½äº†</p>
<p>åœ¨PITå‘ç”Ÿä¸€æ¬¡interruptæ—¶è°ƒç”¨handlerï¼ˆåœ¨IDTä¸­æ³¨å†Œï¼‰ï¼Œåœ¨handlerä¸­è¿›è¡Œä¸€æ¬¡scheduleæ“ä½œ</p>
<p>ä½¿ç”¨Chanel0ä½œä¸ºI&#x2F;O Port    <code>0x40   Channel 0 data port (read/write)</code></p>
<p>å‘0x43 portå†™å…¥é€‰æ‹©çš„channelï¼Œmode</p>
<h3 id="Scheduler"><a href="#Scheduler" class="headerlink" title="Scheduler"></a>Scheduler</h3><p>åœ¨è¿›è¡Œå…·ä½“æµç¨‹ä¹‹å‰ï¼Œå¿…é¡»æ˜ç¡®ä¸€ä¸ªäº‹å®ã€‚ä¸€ä¸ªä¸æ˜¯æ­£åœ¨æ‰§è¡Œçš„processçš„stackä¸Šï¼Œ<strong>å¿…ç„¶æ˜¯schedulerçš„æ®‹ç•™ä¿¡æ¯</strong>ï¼Œå› ä¸ºprocessåªè¦å¼€å§‹æ‰§è¡Œï¼Œåªæœ‰ä¸¤ç§å¯èƒ½é€€å‡ºå½“å‰stackï¼š</p>
<ol>
<li>æ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›user space</li>
<li>è¿˜æœªæ‰§è¡Œå®Œæ¯•ï¼Œä½†æ˜¯è¢«schedulerå¼ºåˆ¶é€€å‡ºï¼Œå»å¾€å…¶ä»–process</li>
</ol>
<p>æ‰€ä»¥åªè¦æˆ‘ä»¬å‘ç°å¯ä»¥æ‰¾åˆ°next processï¼Œé‚£è¿™ä¸ªprocessä¸€å®šæ˜¯å±äº2æƒ…å†µï¼Œå³stackä¸Šæ®‹ç•™äº†ä¸Šä¸€æ¬¡scheduleræœªreturnçš„æ‰€æœ‰ä¿¡æ¯ï¼Œåœ¨æ¥ä¸‹æ¥çš„task switchä¸­ï¼Œä»¥ä¸ºswitchçš„æ—¶å€™ä¾ç„¶ä½¿ç”¨çš„æ˜¯schedulerçš„ä»£ç ï¼Œç›´æ¥æ›´æ”¹espã€ebpå³å¯</p>
<p><img src="/ECE391-MP3-Tutorial/Untitled17.png" alt="Untitled"></p>
<h3 id="æ­¥éª¤-3"><a href="#æ­¥éª¤-3" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h3><p><strong>æ ¸å¿ƒæ€æƒ³1ï¼šscheduleré€šè¿‡æ›´æ”¹esp, ebpå®ç°åœ¨kernel stackä¹‹é—´çš„åˆ‡æ¢</strong></p>
<ol>
<li><p>PITäº§ç”Ÿinterruptï¼Œåœ¨å…¶<code>pit_handler</code>ä¸­å‘¼å«<code>scheduler_linkage (asm)</code></p>
</li>
<li><p>è¿›å…¥scheduleråï¼Œå…ˆ<strong>å‚¨å­˜æœ¬æ¬¡schedulerè¿›å…¥æ—¶çš„ebp</strong>ï¼Œå‚¨å­˜åˆ°<code>pcbâ†’sch_ebp</code>ä¸­</p>
</li>
<li><p>æ‰¾åˆ°åœ¨schedule arrayä¸­çš„ä¸‹ä¸€ä¸ªéœ€è¦è¢«scheduleçš„processï¼Œä»¥ä¸‹ç§°ä¸º**<code>next process</code>**ï¼Œå¹¶æ›´æ–°<code>cur_sch_index</code>ï¼ˆç”¨æ¥æŒ‡ç¤ºå½“å‰scheduleæ˜¯å“ªä¸ªprocessçš„å˜é‡ï¼‰</p>
</li>
<li><p>è‹¥next processçš„pidä¸º-2(TERM_NOT_INITå®)ï¼Œä»£è¡¨ä¸‹ä¸€ä¸ªterminalä¸Šè¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ä»»ä½•è¿›ç¨‹</p>
<ol>
<li><code>remap_video_page(cur_sch_index)</code> æ¥ä¸‹æ¥çš„ä¸€åˆ‡å’Œvideoç›¸å…³æ“ä½œä¼šä½œç”¨åœ¨å³å°†æ–°å¼€å¯çš„shell processä¸Š</li>
<li>æ‰§è¡Œ<code>execute(&#39;shell&#39;)</code></li>
</ol>
 <aside>
 â¡ï¸ è¿™æ ·åšå¯ä»¥è§£å†³åˆšå¼€å§‹ä¸‰ä¸ªprocessçš„kernel stackä¸Šéƒ½æ²¡æœ‰scheduleræ®‹ä½™çš„é—®é¢˜ã€‚ä¸‰ä¸ªç©ºçš„kernel stackä¼šä¸€ä¸ªä¸ªè¢«åˆå§‹åŒ–æˆä¸ºæœ‰scheduleræ®‹ä½™çš„kernel stack
 
 </aside>
 </li>
<li><p>å¦‚æœä¸‹ä¸€ä¸ªterminalå·²ç»æœ‰è¿›ç¨‹å¯ä»¥è¢«scheduleäº†ï¼šä¸ºè¿›å…¥user spaceåšå‡†å¤‡ï¼Œå¯¹user programçš„mapè¿›è¡Œè°ƒæ•´ï¼Œå³å¯¹program imageè¿›è¡Œæ›´æ”¹</p>
<p> å°†user programéƒ¨åˆ†æŒ‡å‘physical memoryä¸­next processçš„program imageã€‚å’Œexecuteä½¿ç”¨ä¸€ä¸ªæ›´æ”¹user program pagingçš„å‡½æ•°</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*   set_user_prog_page</span></span><br><span class="line"><span class="comment"> *   Set page for a user program</span></span><br><span class="line"><span class="comment"> *   input: pid -- the pid of the user program</span></span><br><span class="line"><span class="comment"> *   output: None</span></span><br><span class="line"><span class="comment"> *   side effect: Change the paging directory; Change CR3; flush TLB */</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>æ”¹å˜TSSï¼Œä¸ºå›åˆ°kernel spaceåšå‡†å¤‡</p>
</li>
<li><p>remap user video memory</p>
</li>
<li><p>å‡†å¤‡context switchåˆ°å³å°†åˆ‡æ¢åˆ°çš„process</p>
<p> ä¸èƒ½ç›´æ¥ä½¿ç”¨iretï¼Œè€Œæ˜¯<strong>é‡æ–°è½½å…¥å¦ä¸€ä¸ªprocessçš„ebp</strong>ï¼Œåªæ˜¯ç›¸å½“äºæ¢äº†ä¸€ä¸ªkernel stack</p>
<ol>
<li>åœ¨schedulerä¸­ï¼Œå°†next process <code>pcbâ†’ sch_ebp</code>å–å‡ºæ¥ï¼Œè¿™ä¸ªebpå‚¨å­˜çš„æ˜¯ä¸Šä¸€æ¬¡ä»åˆšåˆšè¿›å…¥scheduleræ—¶çš„stack state</li>
<li>å°†è¿™ä¸ªpcbâ†’sch_ebpèµ‹å€¼ç»™ebpï¼Œå†leave+retï¼Œå®é™…ä¸Šæ˜¯ä»next process kernel stackä¸Šå›åˆ°äº†pit handler</li>
</ol>
</li>
<li><p>åœ¨åˆ‡æ¢stackä¹‹åï¼Œå›åˆ°äº†PIT handlerï¼ŒPIT handlerå†returnï¼Œåˆ™å¯ä»¥åˆ©ç”¨PIT lnk(asm)ä¸­çš„iretï¼Œå¯ä»¥switchåˆ°next processçš„user space</p>
</li>
</ol>
<hr>
<p><img src="/ECE391-MP3-Tutorial/Untitled18.png" alt="Untitled"></p>
<p>virtualçš„0xB8000æŒ‡å‘scheduled processçš„backup bufferï¼Œå¦‚æœå’Œdisplay terminalæ˜¯ä¸€ä¸ªï¼Œåˆ™æŒ‡å‘physicalçš„0xB8000</p>
<p>é”®ç›˜çš„å­—ç¬¦æ°¸è¿œè¦è¾“å…¥åˆ°physicalçš„0xB8000</p>
<h3 id="Video-memory-problems"><a href="#Video-memory-problems" class="headerlink" title="Video memory problems"></a>Video memory problems</h3><p>ä¸Šè¿°å®ç°é€»è¾‘ä¼šé€ æˆvideo memoryå‡ºç°ä¸€å®šçš„é”™ä¹±é—®é¢˜ï¼Œéœ€è¦å¯¹<code>lib.c</code>ä¸­çš„<code>putc</code>å‡½æ•°è¿›è¡Œä¸€å®šçš„æ›´æ”¹</p>
<p>keyboard interruptå‘¼å«putcï¼Œé»˜è®¤æœ0xB8000è¿›è¡Œè¾“å…¥ã€‚ä½†åœ¨scheduleè¿‡ç¨‹ä¸­ï¼Œ0xB8000å› ä¸ºvideo_remapçš„åŸå› ï¼Œæœªå¿…æ—¶åˆ»æŒ‡å‘çœŸå®çš„video memoryï¼Œå¯èƒ½æŒ‡å‘backup bufferã€‚ä½†å®é™…ä¸Šï¼Œkeyboardçš„è¾“å…¥åº”è¯¥æ˜¾ç¤ºåœ¨å½“å‰å±•ç¤ºçš„terminalä¸Šï¼Œè€Œéå½“å‰scheduledçš„terminalä¸Šã€‚</p>
<p>è€Œterminal_writeä¸­å‘¼å«çš„putcï¼Œåˆ™éœ€è¦æ˜¾ç¤ºåœ¨å½“å‰scheduledçš„terminalä¸Šï¼Œè€Œéå½“å‰å±•ç¤ºçš„terminalï¼Œè¿™ä¸keyboardé€»è¾‘æœ‰æ‰€ä¸åŒ</p>
<p>åœ¨å·²ç»æä¾›çš„è®¸å¤šuser programä¸­ï¼Œå¤§å¤šæ•°å‘å±å¹•ä¸Šæ‰“å°çš„æ–¹æ³•æ˜¯å‘¼å«terminal_writeï¼Œè€Œ<code>fish.c</code>æ˜¯ä½¿ç”¨<code>vidmap</code>ç›´æ¥è·å–åœ°å€ç„¶åä¿®æ”¹å€¼</p>
<p>è¿™ä¸€éƒ¨åˆ†æ¯”è¾ƒç¹çç»†ç¢ï¼Œä½†å¹¶ä¸å›°éš¾ï¼Œè¿™ä¸ªç¬”è®°é‡Œä¸è¿‡å¤šèµ˜è¿°ã€‚</p>
<hr>
<h1 id="Extra-Credit"><a href="#Extra-Credit" class="headerlink" title="Extra Credit"></a>Extra Credit</h1><h2 id="Memory-Allocation"><a href="#Memory-Allocation" class="headerlink" title="Memory Allocation"></a>Memory Allocation</h2><p>Two types of memory management</p>
<ol>
<li>Fixed length memory allocation</li>
<li>Varaible length memory allocation</li>
</ol>
<h3 id="Fixed-length-â€”-Slab-Cache"><a href="#Fixed-length-â€”-Slab-Cache" class="headerlink" title="Fixed length â€” Slab Cache"></a>Fixed length â€” Slab Cache</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In this specific implementation, fixed length memory allocation is implemented by two parts, memory management unit and memory unit.</span><br><span class="line">fixed length diagram:</span><br><span class="line">        |memory management unit|  |memory management unit|  |memory management unit|  ..........    |memory unit|  |memory unit| |memory unit| .....</span><br><span class="line">        |next|  ---------------&gt;  |next|  ---------------&gt;  |next|                                      â†‘              â†‘             â†‘</span><br><span class="line">        |ptr|---------------------|ptr|---------------------|ptr|---------------------------------------â†‘--------------â†‘-------------â†‘</span><br></pre></td></tr></table></figure>

<p>Data structure: Linked list</p>
<ul>
<li>Slab_Create ( name , size )</li>
<li>destroy , malloc , free</li>
<li>Automatically shrinks and grows</li>
<li>quick and fast to allocate and free</li>
<li>granularity: 1byte - 4kB-8 bytes</li>
</ul>
<h3 id="Variable-length-â€”-Implicit-free-list"><a href="#Variable-length-â€”-Implicit-free-list" class="headerlink" title="Variable length â€” Implicit free list"></a>Variable length â€” Implicit free list</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">On the other hand, variable length memory allocation is implemented very similar to Linux<span class="number">&#x27;</span>s implicit <span class="built_in">free</span> <span class="built_in">list</span> design. </span><br><span class="line">A memory part consists of two parts, memory management unit and real useable memory unit.</span><br><span class="line">Memory management units are held in a linked <span class="built_in">list</span> to track each memory fragments have been allocated.</span><br><span class="line">variable length diagram:</span><br><span class="line">        |memory mangement unit| -&gt; |memory mangement unit| -&gt; |memory mangement unit| -&gt; |memory mangement unit|</span><br><span class="line">        -----------------------    -----------------------    -----------------------    -----------------------</span><br><span class="line">        |                     |    |                     |    |                     |    |                     |</span><br><span class="line">        |   useable memory    |    |   useable memory    |    |   useable memory    |    |   useable memory    |</span><br><span class="line">        |                     |    |                     |    -----------------------    |                     |</span><br><span class="line">        |                     |    -----------------------                               -----------------------</span><br><span class="line">        |                     |</span><br><span class="line">        -----------------------</span><br><span class="line"></span><br><span class="line">Slab cache<span class="number">&#x27;</span>s implementation is based on fixed length memory allocation.</span><br></pre></td></tr></table></figure>

<p>Data structure: Implicit free list</p>
<ul>
<li>varmalloc( size )</li>
<li>flexible: can allocate any size</li>
<li>granularity: 1byte - 4MB</li>
</ul>
<h2 id="Signal"><a href="#Signal" class="headerlink" title="Signal"></a>Signal</h2><p>Support users to set handler they define</p>
<p>Support sigreturn and set_handler syscall</p>
<p>Support five signals:</p>
<ol>
<li>SIG_DIV_ZERO</li>
<li>SIG_SEGFAULT</li>
<li>SIG_INTERRUPT</li>
<li>SIG_ALARM</li>
<li>SIG_USER1</li>
</ol>
<h2 id="ATA-Hard-Disk-Support-amp-File-System"><a href="#ATA-Hard-Disk-Support-amp-File-System" class="headerlink" title="ATA Hard Disk Support &amp; File System"></a>ATA Hard Disk Support &amp; File System</h2><ul>
<li><p>Writable file system</p>
  <figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">write fname contents</span><br></pre></td></tr></table></figure>
</li>
<li><p>Persistent Change (after reboot) by saving the change to the hard drive</p>
</li>
<li><p>How the file system is loaded and initialized:</p>
</li>
</ul>
<p><img src="/ECE391-MP3-Tutorial/Untitled19.png" alt="Untitled"></p>
<h2 id="Speaker-Driver"><a href="#Speaker-Driver" class="headerlink" title="Speaker Driver"></a>Speaker Driver</h2><p>Toggle <strong><strong><strong><strong><strong><strong><strong>NumLock</strong></strong></strong></strong></strong></strong></strong> to turn on&#x2F;off</p>
<p>Key mapping:</p>
<p>(C3~E4) ZSXDCVGBHNJM,L.;&#x2F;</p>
<p>(C4~G5) Q2W3ER5T6Y7UI9O0P[&#x3D;]</p>
<p>Runs concurrently with any user programs &amp; across terminals</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/First-Post/" rel="prev" title="First Post">
      <i class="fa fa-chevron-left"></i> First Post
    </a></div>
      <div class="post-nav-item">
    <a href="/ZinixOS/" rel="next" title="ZinixOS">
      ZinixOS <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#ECE391-MP3"><span class="nav-number">1.</span> <span class="nav-text">ECE391 MP3</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Checkpoint-1"><span class="nav-number">2.</span> <span class="nav-text">Checkpoint 1</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#OS-Booting-GDT-amp-IDT-Setup"><span class="nav-number">2.1.</span> <span class="nav-text">OS Booting: GDT &amp; IDT Setup</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#GDT"><span class="nav-number">2.1.1.</span> <span class="nav-text">GDT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IDT"><span class="nav-number">2.1.2.</span> <span class="nav-text">IDT</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Device-and-Interrupt"><span class="nav-number">2.2.</span> <span class="nav-text">Device and Interrupt</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#PIC"><span class="nav-number">2.2.1.</span> <span class="nav-text">PIC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RTC"><span class="nav-number">2.2.2.</span> <span class="nav-text">RTC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Keyboard"><span class="nav-number">2.2.3.</span> <span class="nav-text">Keyboard</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Paging"><span class="nav-number">2.3.</span> <span class="nav-text">Paging</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#kernel-c"><span class="nav-number">2.3.1.</span> <span class="nav-text">kernel.c</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#page-c-page-h"><span class="nav-number">2.3.2.</span> <span class="nav-text">page.c, page.h</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Checkpoint-2"><span class="nav-number">3.</span> <span class="nav-text">Checkpoint 2</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Terminal-Driver"><span class="nav-number">3.1.</span> <span class="nav-text">Terminal Driver</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Read-only-File-system"><span class="nav-number">3.2.</span> <span class="nav-text">Read-only File system</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">3.2.1.</span> <span class="nav-text">åŸºæœ¬æ•°æ®ç»“æ„</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#filesystem-init"><span class="nav-number">3.2.2.</span> <span class="nav-text">filesystem_init</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Three-base-functions"><span class="nav-number">3.2.3.</span> <span class="nav-text">Three base functions</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#The-Real-Time-Clock-Driver"><span class="nav-number">3.3.</span> <span class="nav-text">The Real-Time Clock Driver</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Checkpoint-3"><span class="nav-number">4.</span> <span class="nav-text">Checkpoint 3</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#System-Calls"><span class="nav-number">4.1.</span> <span class="nav-text">System Calls</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Wrapper-amp-Linkage"><span class="nav-number">4.1.1.</span> <span class="nav-text">Wrapper &amp; Linkage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#System-call-handler"><span class="nav-number">4.1.2.</span> <span class="nav-text">System call handler</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Execute-sys-call%E5%85%B7%E4%BD%93%E6%B5%81%E7%A8%8B"><span class="nav-number">4.1.3.</span> <span class="nav-text">Execute sys callå…·ä½“æµç¨‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Halt-sys-call%E5%85%B7%E4%BD%93%E6%B5%81"><span class="nav-number">4.1.4.</span> <span class="nav-text">Halt sys callå…·ä½“æµ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Tasks"><span class="nav-number">4.2.</span> <span class="nav-text">Tasks</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Loader"><span class="nav-number">4.3.</span> <span class="nav-text">Loader</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Executing-User-level-Code"><span class="nav-number">4.4.</span> <span class="nav-text">Executing User-level Code</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Process-Control-Block"><span class="nav-number">4.5.</span> <span class="nav-text">Process Control Block</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Checkpoint-4"><span class="nav-number">5.</span> <span class="nav-text">Checkpoint 4</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#getargs"><span class="nav-number">5.1.</span> <span class="nav-text">getargs</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4"><span class="nav-number">5.1.1.</span> <span class="nav-text">æ­¥éª¤</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#vidmap"><span class="nav-number">5.2.</span> <span class="nav-text">vidmap</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4-1"><span class="nav-number">5.2.1.</span> <span class="nav-text">æ­¥éª¤</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Checkpoint-5"><span class="nav-number">6.</span> <span class="nav-text">Checkpoint 5</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Multiple-Terminals"><span class="nav-number">6.1.</span> <span class="nav-text">Multiple Terminals</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Initialization"><span class="nav-number">6.1.1.</span> <span class="nav-text">Initialization</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Separate-I-x2F-O-buffer"><span class="nav-number">6.1.2.</span> <span class="nav-text">Separate I&#x2F;O buffer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Isolation"><span class="nav-number">6.1.3.</span> <span class="nav-text">Isolation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Switch"><span class="nav-number">6.1.4.</span> <span class="nav-text">Switch</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4-2"><span class="nav-number">6.1.5.</span> <span class="nav-text">æ­¥éª¤</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Scheduling"><span class="nav-number">6.2.</span> <span class="nav-text">Scheduling</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#PIT"><span class="nav-number">6.2.1.</span> <span class="nav-text">PIT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Scheduler"><span class="nav-number">6.2.2.</span> <span class="nav-text">Scheduler</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4-3"><span class="nav-number">6.2.3.</span> <span class="nav-text">æ­¥éª¤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Video-memory-problems"><span class="nav-number">6.2.4.</span> <span class="nav-text">Video memory problems</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Extra-Credit"><span class="nav-number">7.</span> <span class="nav-text">Extra Credit</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Memory-Allocation"><span class="nav-number">7.1.</span> <span class="nav-text">Memory Allocation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Fixed-length-%E2%80%94-Slab-Cache"><span class="nav-number">7.1.1.</span> <span class="nav-text">Fixed length â€” Slab Cache</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Variable-length-%E2%80%94-Implicit-free-list"><span class="nav-number">7.1.2.</span> <span class="nav-text">Variable length â€” Implicit free list</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Signal"><span class="nav-number">7.2.</span> <span class="nav-text">Signal</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ATA-Hard-Disk-Support-amp-File-System"><span class="nav-number">7.3.</span> <span class="nav-text">ATA Hard Disk Support &amp; File System</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Speaker-Driver"><span class="nav-number">7.4.</span> <span class="nav-text">Speaker Driver</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Zicheng Ma</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">5</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/ZichengMa" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;ZichengMa" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/zma17@illinois.edu" title="E-Mail â†’ zma17@illinois.edu"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Friend Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://silkrow3.wordpress.com/" title="https:&#x2F;&#x2F;silkrow3.wordpress.com&#x2F;" rel="noopener" target="_blank">ErkaiYu</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://moomoohorse.com/home/" title="https:&#x2F;&#x2F;moomoohorse.com&#x2F;home&#x2F;" rel="noopener" target="_blank">HaoRen</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zicheng Ma</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
